<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Opener</title>
    
    <!-- SKRYPTY FIREBASE (bez zmian) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-bg: #1a1c20; --secondary-bg: #2a2d32; --text-color: #e0e0e0;
            --accent-color: #4d88ff; --gold-color: #ffd700; --border-color: #444;
            /* Rarity Glow Colors */
            --rarity-legendary: #ffd700; /* 0% - 1% */
            --rarity-epic: #da70d6;      /* 1% - 5% */
            --rarity-rare: #4d88ff;      /* 5% - 20% */
            --rarity-common: #9d9d9d;   /* > 20% */
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--primary-bg); color: var(--text-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1200px; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-size: 2.5em; color: var(--accent-color); }
        .section-title { font-size: 2em; color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        
        /* --- NOWE STYLE DLA ZAKŁADEK --- */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }
        .tab-btn {
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-color);
            padding: 15px 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background-color: var(--secondary-bg);
        }
        .tab-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .tab-pane {
            display: none; /* Domyślnie ukryj wszystkie panele */
            animation: fadeInContent 0.5s ease;
        }
        .tab-pane.active {
            display: block; /* Pokazuj tylko aktywny panel */
        }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }


        /* --- Style Logowania (bez zmian) --- */
        #auth-container { text-align: center; margin-bottom: 30px; }
        #user-info { display: none; align-items: center; justify-content: center; gap: 15px; font-size: 1.1em; }
        #user-name { font-weight: bold; }
        #logout-btn { background-color:#dc3545; font-size: 0.9em; padding: 8px 15px; }

        /* --- Style Skrzynek (bez zmian) --- */
        #case-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; justify-items: center; }
        .case-card { background-color: var(--secondary-bg); border-radius: 8px; border: 1px solid var(--border-color); text-align: center; padding: 20px; text-decoration: none; color: var(--text-color); transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s; width: 100%; box-sizing: border-box; }
        .case-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .case-card img { max-width: 150px; height: 150px; object-fit: contain; }
        .case-card h2 { margin: 15px 0 5px; font-size: 1.4em; }
        .case-card .price { font-size: 1.1em; font-weight: bold; color: #28a745; }

        /* --- Inventory Styles (bez zmian) --- */
        .inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #balance-display { font-size: 1.8em; font-weight: bold; color: var(--gold-color); }
        .btn { color: white; border: none; padding: 10px 20px; font-size: 1em; font-weight: bold; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        #sell-all-btn { background-color: #e64c4c; }
        #sell-all-btn:hover { background-color: #c0392b; }
        #inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; background-color: var(--primary-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); min-height: 150px; }
        .inventory-item { background-color: var(--secondary-bg); border: 2px solid var(--border-color); border-radius: 8px; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; transition: box-shadow 0.3s, border-color 0.3s; }
        .inventory-item.locked { border-color: #e64c4c; }
        .inventory-item img { max-width: 100px; height: 80px; object-fit: contain; margin: 0 auto 10px; }
        .item-name { font-weight: bold; font-size: 1em; margin-bottom: 5px; word-wrap: break-word; }
        .item-chance { font-size: 0.8em; color: #aaa; margin-bottom: 8px; }
        .item-value { font-size: 0.9em; color: var(--gold-color); margin-bottom: 10px; }
        .item-actions { display: flex; flex-direction: column; gap: 5px; }
        .action-btn { background-color: #6c757d; color: white; border: none; padding: 8px 12px; font-size: 0.9em; border-radius: 5px; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        .sell-btn { background-color: #28a745; }
        .sell-btn:hover { background-color: #218838; }
        .sell-btn:disabled { background-color: #555; color: #999; cursor: not-allowed; }
        .lock-btn { background-color: var(--accent-color); }
        .lock-btn.locked { background-color: #e64c4c; }
        .lock-btn:hover { background-color: #3a70e0; }
        .lock-btn.locked:hover { background-color: #c0392b; }
        .rarity-legendary { box-shadow: 0 0 15px 3px var(--rarity-legendary); border-color: var(--rarity-legendary); }
        .rarity-epic { box-shadow: 0 0 12px 2px var(--rarity-epic); border-color: var(--rarity-epic); }
        .rarity-rare { box-shadow: 0 0 10px 1px var(--rarity-rare); border-color: var(--rarity-rare); }
        .rarity-common { box-shadow: 0 0 8px 0px var(--rarity-common); border-color: var(--rarity-common); }

        /* --- Leaderboard Styles (bez zmian) --- */
        #leaderboard-table { width: 100%; border-collapse: collapse; background-color: var(--secondary-bg); border-radius: 8px; overflow: hidden; }
        #leaderboard-table th, #leaderboard-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #leaderboard-table th { background-color: var(--primary-bg); }
        #leaderboard-table td:first-child { font-weight: bold; color: var(--accent-color); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Case Opener</h1>
        </header>

        <main>
            <div id="auth-container">
                <button id="login-btn" class="btn">Login with Google</button>
                <div id="user-info">
                    <span id="user-name"></span>
                    <button id="logout-btn" class="btn">Logout</button>
                </div>
            </div>

            <!-- NOWA NAWIGACJA ZAKŁADEK -->
            <nav class="tabs">
                <button class="tab-btn active" data-tab="cases">Cases</button>
                <button class="tab-btn" data-tab="inventory">Inventory</button>
                <button class="tab-btn" data-tab="leaderboard">Leaderboard</button>
            </nav>

            <!-- NOWY KONTENER NA ZAWARTOŚĆ ZAKŁADEK -->
            <div class="tab-content-container">

                <!-- ZAKŁADKA 1: SKRZYNKI (domyślnie aktywna) -->
                <div id="cases-content" class="tab-pane active">
                    <h2 class="section-title">Select a Case</h2>
                    <div id="case-selection-grid">
                        <a href="glorp-case.html" class="case-card">
                            <img src="case.png" alt="Glorp Case">
                            <h2>Glorp Case</h2>
                            <p class="price">Free</p>
                        </a>
                        <!-- Tutaj możesz dodać więcej skrzynek -->
                    </div>
                </div>

                <!-- ZAKŁADKA 2: EKWIPUNEK -->
                <div id="inventory-content" class="tab-pane">
                    <div class="inventory-section">
                        <div class="inventory-header">
                            <h2 class="section-title" style="margin-bottom:0;">Inventory</h2>
                            <div id="balance-display">0 glorpies</div>
                        </div>
                        <div style="text-align: right; margin-bottom: 20px;">
                            <button id="sell-all-btn" class="btn">Sell All Unlocked</button>
                        </div>
                        <div id="inventory-grid"></div>
                    </div>
                </div>

                <!-- ZAKŁADKA 3: LEADERBOARD -->
                <div id="leaderboard-content" class="tab-pane">
                    <div class="leaderboard-section">
                        <h2 class="section-title">Leaderboard</h2>
                        <table id="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Glorpies</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body">
                                <tr><td colspan="3" style="text-align: center;">Log in to see the leaderboard.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div> <!-- Koniec tab-content-container -->
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SEKCJA ZAKŁADEK: NOWY KOD DO PRZEŁĄCZANIA ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Usuń klasę 'active' ze wszystkich przycisków i paneli
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanes.forEach(pane => pane.classList.remove('active'));

                // Dodaj klasę 'active' do klikniętego przycisku
                button.classList.add('active');

                // Znajdź i pokaż odpowiedni panel na podstawie atrybutu data-tab
                const targetPaneId = button.dataset.tab + '-content';
                document.getElementById(targetPaneId).classList.add('active');
            });
        });

        // --- CAŁA RESZTA KODU POZOSTAJE BEZ ZMIAN ---

        // 1. Inicjalizacja Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCHbe8Wy43kw5yglmuvQ4RoU4-l9zlkl-w",
            authDomain: "case-opener-login.firebaseapp.com",
            projectId: "case-opener-login",
            storageBucket: "case-opener-login.appspot.com",
            messagingSenderId: "763174924074",
            appId: "1:763174924074:web:beeafe85f4f63c23cbb853"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Referencje do elementów UI
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfoDiv = document.getElementById('user-info');
        const userNameSpan = document.getElementById('user-name');
        const balanceDisplay = document.getElementById('balance-display');
        const inventoryGrid = document.getElementById('inventory-grid');
        const sellAllBtn = document.getElementById('sell-all-btn');
        const caseLink = document.querySelector('#case-selection-grid a');
        const leaderboardBody = document.getElementById('leaderboard-body');

        let currentUser = null;
        let playerData = { glorpies: 0, inventory: [], username: 'Guest' };

        // KONFIGURACJA PRZEDMIOTÓW...
        const FOLDER_PATH = '';
        const USE_CUSTOM_CHANCES = true;
        const CUSTOM_CHANCES = {
            'Glorp-10.png':           34.36, 'Glorp-Jam-15.gif':       22.91,
            'Bday-Glorp-30.gif':      11.45, 'Christmas-Glorp-45.png': 7.63,
            'Glorpium-50.png':        6.87,  'Glorp-Cheer-50.gif':     6.87,
            'Glorp-Feet-75.gif':      5.33,  'Rainbow-Glorp-100.gif':  4.58
        };
        const itemFilenames = Object.keys(CUSTOM_CHANCES);
        let caseItems = [];
        
        const parseValue = f => parseInt((f.match(/(\d+)\.(png|gif)$/i) || [])[1] || 0, 10);
        const parseName = f => { const p = f.replace(/\.(png|gif)$/i, '').split('-'); p.pop(); return p.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); };
        const formatGlorpies = n => (n || 0).toLocaleString('en-US') + ' glorpies';
        
        function initializeCaseItems() {
            const itemsData = itemFilenames.map(f => ({ filename: f, name: parseName(f), value: parseValue(f) })).filter(i => i.value > 0);
            if (USE_CUSTOM_CHANCES) {
                caseItems = itemsData.map(item => ({ ...item, probability: CUSTOM_CHANCES[item.filename] || 0 }));
            }
        }
        
        function getRarityClass(probability) {
            if (probability <= 1) return 'rarity-legendary'; if (probability <= 5) return 'rarity-epic';
            if (probability <= 20) return 'rarity-rare'; return 'rarity-common';
        }

        initializeCaseItems();

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                loginBtn.style.display = 'none';
                userInfoDiv.style.display = 'flex';
                caseLink.style.pointerEvents = 'auto';
                caseLink.style.opacity = 1;
                await loadPlayerData();
                await loadLeaderboard();
            } else {
                currentUser = null;
                loginBtn.style.display = 'block';
                userInfoDiv.style.display = 'none';
                caseLink.style.pointerEvents = 'none';
                caseLink.style.opacity = 0.5;
                playerData = { glorpies: 0, inventory: [], username: 'Guest' };
                leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Log in to see the leaderboard.</td></tr>';
                updateUI();
            }
        });

        loginBtn.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                const userDocRef = db.collection('users').doc(user.uid);
                const userDoc = await userDocRef.get();

                if (!userDoc.exists) {
                    let username = ''; let isUnique = false;
                    while(!isUnique) {
                        username = prompt("Welcome! Please choose your unique username (3-15 characters, no spaces):", user.displayName.split(' ')[0].substring(0, 15));
                        if (!username || username.length < 3 || username.length > 15 || /\s/.test(username)) {
                            alert("Invalid username. It must be 3-15 characters long and contain no spaces.");
                            continue;
                        }
                        const usersWithSameName = await db.collection('users').where('username_lowercase', '==', username.toLowerCase()).get();
                        if (usersWithSameName.empty) { isUnique = true; } else { alert("This username is already taken. Please try another one."); }
                    }
                    
                    await userDocRef.set({
                        username: username, username_lowercase: username.toLowerCase(),
                        email: user.email, glorpies: 100, inventory: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) { console.error("Login Error:", error); }
        });

        logoutBtn.addEventListener('click', () => { auth.signOut(); });

        async function loadPlayerData() {
            if (!currentUser) return;
            const userDocRef = db.collection('users').doc(currentUser.uid);
            const doc = await userDocRef.get();
            if (doc.exists) {
                playerData = doc.data();
                userNameSpan.textContent = `Welcome, ${playerData.username}!`;
            }
            updateUI();
        }

        async function savePlayerData() {
            if (!currentUser) return;
            const userDocRef = db.collection('users').doc(currentUser.uid);
            try {
                await userDocRef.update({ glorpies: playerData.glorpies, inventory: playerData.inventory });
            } catch (error) { console.error("Error saving data:", error); }
        }

        async function loadLeaderboard() {
            leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Loading...</td></tr>';
            try {
                const snapshot = await db.collection('users').orderBy('glorpies', 'desc').limit(10).get();
                if (snapshot.empty) { leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No players.</td></tr>'; return; }
                leaderboardBody.innerHTML = ''; let rank = 1;
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const isCurrentUser = currentUser && currentUser.uid === doc.id;
                    const row = `<tr style="${isCurrentUser ? 'background-color: var(--accent-color); color: white;' : ''}"><td>#${rank}</td><td>${user.username}</td><td>${formatGlorpies(user.glorpies)}</td></tr>`;
                    leaderboardBody.innerHTML += row;
                    rank++;
                });
            } catch (error) { console.error("Error loading leaderboard:", error); }
        }

        function updateUI() {
            balanceDisplay.textContent = formatGlorpies(playerData.glorpies);
            inventoryGrid.innerHTML = playerData.inventory.length === 0 ? '<p style="color:#888; text-align:center; grid-column: 1 / -1;">Your inventory is empty.</p>' :
            playerData.inventory.map((item, index) => {
                const itemDetails = caseItems.find(ci => ci.filename === item.filename); if (!itemDetails) return '';
                const prob = itemDetails.probability; const rarityClass = getRarityClass(prob);
                const probText = prob < 0.001 ? '<0.001%' : prob.toFixed(2) + '%';
                return `<div class="inventory-item ${rarityClass} ${item.locked ? 'locked' : ''}"><img src="${FOLDER_PATH + item.filename}" alt="${itemDetails.name}"><p class="item-name">${itemDetails.name}</p><p class="item-chance">Drop: ${probText}</p><p class="item-value">${formatGlorpies(itemDetails.value)}</p><div class="item-actions"><button class="action-btn sell-btn" data-index="${index}" ${item.locked ? 'disabled' : ''}>Sell</button><button class="action-btn lock-btn ${item.locked ? 'locked' : ''}" data-index="${index}">${item.locked ? 'Unlock' : 'Lock'}</button></div></div>`;
            }).join('');
        }

        inventoryGrid.addEventListener('click', e => {
            if (!e.target.dataset.index) return; const index = parseInt(e.target.dataset.index, 10); const item = playerData.inventory[index]; if (!item) return;
            if (e.target.classList.contains('sell-btn')) { if (item.locked) return; playerData.glorpies += parseValue(item.filename); playerData.inventory.splice(index, 1); } 
            else if (e.target.classList.contains('lock-btn')) { item.locked = !item.locked; }
            savePlayerData(); updateUI();
        });

        sellAllBtn.addEventListener('click', () => {
            let totalValue = 0; const itemsToKeep = [], itemsToSell = [];
            playerData.inventory.forEach(item => item.locked ? itemsToKeep.push(item) : (itemsToSell.push(item), totalValue += parseValue(item.filename)));
            if (itemsToSell.length === 0) return alert("No unlocked items to sell.");
            if (confirm(`Sell ${itemsToSell.length} item(s) for ${formatGlorpies(totalValue)}?`)) {
                playerData.glorpies += totalValue; playerData.inventory = itemsToKeep;
                savePlayerData(); updateUI();
            }
        });
    });
    </script>
</body>
</html>
