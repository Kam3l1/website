<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Opener</title>
    
    <!-- SKRYPTY FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-bg: #1a1c20; --secondary-bg: #2a2d32; --text-color: #e0e0e0;
            --accent-color: #4d88ff; --gold-color: #ffd700; --border-color: #444;
            --rarity-legendary: #ffd700; --rarity-epic: #da70d6;
            --rarity-rare: #4d88ff; --rarity-common: #9d9d9d;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--primary-bg); color: var(--text-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1200px; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-size: 2.5em; color: var(--accent-color); }
        .section-title { font-size: 2em; color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid var(--border-color); }
        .tab-btn { background-color: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-color); padding: 15px 25px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .tab-btn:hover { background-color: var(--secondary-bg); }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .tab-pane { display: none; animation: fadeInContent 0.5s ease; }
        .tab-pane.active { display: block; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #auth-container { text-align: center; margin-bottom: 30px; }
        #user-info { display: none; align-items: center; justify-content: center; gap: 15px; font-size: 1.1em; }
        #user-name { font-weight: bold; }
        #logout-btn { background-color:#dc3545; font-size: 0.9em; padding: 8px 15px; }
        #case-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; justify-items: center; }
        .case-card { background-color: var(--secondary-bg); border-radius: 8px; border: 1px solid var(--border-color); text-align: center; padding: 20px; text-decoration: none; color: var(--text-color); transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s; width: 100%; box-sizing: border-box; }
        .case-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .case-card img { max-width: 150px; height: 150px; object-fit: contain; }
        .case-card h2 { margin: 15px 0 5px; font-size: 1.4em; }
        .case-card .price { font-size: 1.1em; font-weight: bold; }
        .case-card .price.free { color: #28a745; }
        .case-card .price.paid { color: var(--gold-color); }
        .inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #balance-display { font-size: 1.8em; font-weight: bold; color: var(--gold-color); }
        .btn { color: white; border: none; padding: 10px 20px; font-size: 1em; font-weight: bold; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        #sell-all-btn { background-color: #e64c4c; }
        #inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; background-color: var(--primary-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); min-height: 150px; }
        .inventory-item { position: relative; background-color: var(--secondary-bg); border: 2px solid var(--border-color); border-radius: 8px; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; transition: box-shadow 0.3s, border-color 0.3s; }
        .item-count { position: absolute; top: 5px; right: 5px; background-color: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.9em; font-weight: bold; }
        .inventory-item.locked { border-color: #e64c4c; }
        .inventory-item img { max-width: 100px; height: 80px; object-fit: contain; margin: 0 auto 10px; }
        .item-name { font-weight: bold; font-size: 1em; margin-bottom: 5px; word-wrap: break-word; }
        .item-chance { font-size: 0.8em; color: #aaa; margin-bottom: 8px; }
        .item-value { font-size: 0.9em; color: var(--gold-color); margin-bottom: 10px; }
        .item-actions { display: flex; flex-direction: column; gap: 5px; }
        .action-btn { background-color: #6c757d; color: white; border: none; padding: 8px 12px; font-size: 0.9em; border-radius: 5px; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        .sell-btn { background-color: #28a745; }
        .sell-btn:disabled { background-color: #555; cursor: not-allowed; }
        .lock-btn { background-color: var(--accent-color); }
        .lock-btn.locked { background-color: #e64c4c; }
        .rarity-legendary { box-shadow: 0 0 15px 3px var(--rarity-legendary); border-color: var(--rarity-legendary); }
        .rarity-epic { box-shadow: 0 0 12px 2px var(--rarity-epic); border-color: var(--rarity-epic); }
        .rarity-rare { box-shadow: 0 0 10px 1px var(--rarity-rare); border-color: var(--rarity-rare); }
        .rarity-common { box-shadow: 0 0 8px 0px var(--rarity-common); border-color: var(--rarity-common); }
        #leaderboard-table { width: 100%; border-collapse: collapse; background-color: var(--secondary-bg); border-radius: 8px; overflow: hidden; }
        #leaderboard-table th, #leaderboard-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #leaderboard-table th { background-color: var(--primary-bg); }
        #leaderboard-table td:first-child { font-weight: bold; color: var(--accent-color); }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Case Opener</h1></header>
        <main>
            <div id="auth-container">
                <button id="login-btn" class="btn">Login with Google</button>
                <div id="user-info">
                    <span id="user-name"></span>
                    <button id="logout-btn" class="btn">Logout</button>
                </div>
            </div>
            <nav class="tabs">
                <button class="tab-btn active" data-tab="cases">Cases</button>
                <button class="tab-btn" data-tab="inventory">Inventory</button>
                <button class="tab-btn" data-tab="leaderboard">Leaderboard</button>
            </nav>
            <div class="tab-content-container">
                <div id="cases-content" class="tab-pane active">
                    <h2 class="section-title">Select a Case</h2>
                    <div id="case-selection-grid"></div>
                </div>
                <div id="inventory-content" class="tab-pane">
                    <div class="inventory-section">
                        <div class="inventory-header">
                            <h2 class="section-title" style="margin-bottom:0;">Inventory</h2>
                            <div id="balance-display">0 glorpies</div>
                        </div>
                        <div style="text-align: right; margin-bottom: 20px;">
                            <button id="sell-all-btn" class="btn">Sell All Unlocked</button>
                        </div>
                        <div id="inventory-grid"></div>
                    </div>
                </div>
                <div id="leaderboard-content" class="tab-pane">
                    <div class="leaderboard-section">
                        <h2 class="section-title">Leaderboard</h2>
                        <table id="leaderboard-table">
                            <thead><tr><th>Rank</th><th>Player</th><th>Glorpies</th></tr></thead>
                            <tbody id="leaderboard-body">
                                <tr><td colspan="3" style="text-align: center;">Log in to see the leaderboard.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const FOLDER_PATH = '';
        const CASES = { 'glorp-case': { name: "Glorp Case", file: "glorp-case.html", cost: 0, image: "case.png", odds: { 'Glorp-10.png': 34.36, 'Glorp-Jam-15.gif': 22.91, 'Bday-Glorp-30.gif': 11.45, 'Christmas-Glorp-45.png': 7.63, 'Glorpium-50.png': 6.87, 'Glorp-Cheer-50.gif': 6.87, 'Glorp-Feet-75.gif': 5.33, 'Rainbow-Glorp-100.gif': 4.58 }}, 'test-case': { name: "Test Case", file: "test-case.html", cost: 500, image: "case.png", odds: { 'Test-Item-5000.png': 100 } } };
        let allItemFilenames = [];
        for (const caseId in CASES) { allItemFilenames.push(...Object.keys(CASES[caseId].odds)); }
        allItemFilenames = [...new Set(allItemFilenames)];
        let caseItems = [];
        
        const firebaseConfig = { apiKey: "AIzaSyCHbe8Wy43kw5yglmuvQ4RoU4-l9zlkl-w", authDomain: "case-opener-login.firebaseapp.com", projectId: "case-opener-login", storageBucket: "case-opener-login.appspot.com", messagingSenderId: "763174924074", appId: "1:763174924074:web:beeafe85f4f63c23cbb853" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const tabButtons = document.querySelectorAll('.tab-btn'), tabPanes = document.querySelectorAll('.tab-pane'), loginBtn = document.getElementById('login-btn'), logoutBtn = document.getElementById('logout-btn'), userInfoDiv = document.getElementById('user-info'), userNameSpan = document.getElementById('user-name'), caseGrid = document.getElementById('case-selection-grid'), balanceDisplay = document.getElementById('balance-display'), inventoryGrid = document.getElementById('inventory-grid'), sellAllBtn = document.getElementById('sell-all-btn'), leaderboardBody = document.getElementById('leaderboard-body');
        let currentUser = null;
        let playerData = { glorpies: 0, inventory: {}, username: 'Guest' };
        
        const parseValue = f => parseInt((f.match(/(\d+)\.(png|gif)$/i) || [])[1] || 0, 10);
        const parseName = f => { const p = f.replace(/\.(png|gif)$/i, '').split('-'); p.pop(); return p.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); };
        const formatGlorpies = n => (n || 0).toLocaleString('en-US') + ' glorpies';
        const getRarityClass = p => { if (p <= 1) return 'rarity-legendary'; if (p <= 5) return 'rarity-epic'; if (p <= 20) return 'rarity-rare'; return 'rarity-common'; };

        function generateCaseCards() {
            caseGrid.innerHTML = '';
            for (const caseId in CASES) {
                const caseData = CASES[caseId];
                const priceText = caseData.cost === 0 ? 'Free' : `${(caseData.cost).toLocaleString('en-US')} glorpies`;
                const priceClass = caseData.cost === 0 ? 'free' : 'paid';
                caseGrid.innerHTML += `<a href="${caseData.file}" class="case-card"><img src="${FOLDER_PATH}${caseData.image}" alt="${caseData.name}" style="${caseId === 'test-case' ? 'filter: hue-rotate(180deg);' : ''}"><h2>${caseData.name}</h2><p class="price ${priceClass}">${priceText}</p></a>`;
            }
        }

        function initializeCaseItems() {
            caseItems = allItemFilenames.map(filename => {
                let probability = 0;
                for (const caseId in CASES) { if (CASES[caseId].odds[filename]) { probability = CASES[caseId].odds[filename]; break; } }
                return { filename, name: parseName(filename), value: parseValue(filename), probability };
            }).filter(i => i.value > 0);
        }
        
        tabButtons.forEach(button => button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); tabPanes.forEach(pane => pane.classList.remove('active')); button.classList.add('active'); document.getElementById(button.dataset.tab + '-content').classList.add('active'); }));
        generateCaseCards(); initializeCaseItems();

        auth.onAuthStateChanged(async user => {
            const caseLinks = document.querySelectorAll('#case-selection-grid a');
            if (user) {
                currentUser = user;
                loginBtn.style.display = 'none'; userInfoDiv.style.display = 'flex';
                caseLinks.forEach(link => { link.style.pointerEvents = 'auto'; link.style.opacity = 1; });
                await loadPlayerData(); await loadLeaderboard();
            } else {
                currentUser = null;
                loginBtn.style.display = 'block'; userInfoDiv.style.display = 'none';
                caseLinks.forEach(link => { link.style.pointerEvents = 'none'; link.style.opacity = 0.5; });
                playerData = { glorpies: 0, inventory: {}, username: 'Guest' };
                leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Log in to see the leaderboard.</td></tr>';
                updateUI();
            }
        });

        loginBtn.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                const userPublicRef = db.collection('users').doc(user.uid);
                const userPrivateRef = db.collection('user_private_data').doc(user.uid);
                const [publicDoc, privateDoc] = await Promise.all([userPublicRef.get(), userPrivateRef.get()]);
                
                if (!publicDoc.exists || !privateDoc.exists) {
                    console.log("Wykryto nowego użytkownika lub niekompletne dane. Uruchamiam proces tworzenia profilu...");
                    let username = ''; let isUnique = false;
                    while (!isUnique) {
                        username = prompt("Welcome! Please choose your unique username (3-15 characters, no spaces):", user.displayName.split(' ')[0].substring(0, 15));
                        if (!username || username.length < 3 || username.length > 15 || /\s/.test(username)) {
                            alert("Invalid username."); continue;
                        }
                        const usersWithSameName = await db.collection('users').where('username_lowercase', '==', username.toLowerCase()).get();
                        if (usersWithSameName.empty) { isUnique = true; } else { alert("This username is taken."); }
                    }
                    const batch = db.batch();
                    batch.set(userPublicRef, { username, username_lowercase: username.toLowerCase(), glorpies: 100, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    batch.set(userPrivateRef, { email: user.email, inventory: {} });
                    await batch.commit();
                    console.log("Utworzono poprawnie oba dokumenty dla nowego użytkownika.");
                }
            } catch (error) { console.error("Login Error:", error); }
        });

        logoutBtn.addEventListener('click', () => auth.signOut());

        async function loadPlayerData() {
            if (!currentUser) return;
            const userPublicRef = db.collection('users').doc(currentUser.uid);
            const userPrivateRef = db.collection('user_private_data').doc(currentUser.uid);
            try {
                const [publicDoc, privateDoc] = await Promise.all([userPublicRef.get(), userPrivateRef.get()]);
                if (publicDoc.exists && privateDoc.exists) {
                    playerData = { ...publicDoc.data(), ...privateDoc.data() };
                    userNameSpan.textContent = `Welcome, ${playerData.username}!`;
                }
                updateUI();
            } catch (error) { console.error("Error loading player data:", error); }
        }

        async function savePlayerData() {
            if (!currentUser) return;
            const userPublicRef = db.collection('users').doc(currentUser.uid);
            const userPrivateRef = db.collection('user_private_data').doc(currentUser.uid);
            try {
                await userPublicRef.update({ glorpies: playerData.glorpies });
                await userPrivateRef.update({ inventory: playerData.inventory });
            } catch (error) { console.error("Error saving data:", error); }
        }

        async function loadLeaderboard() {
            leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Loading...</td></tr>';
            try {
                const snapshot = await db.collection('users').orderBy('glorpies', 'desc').limit(10).get();
                if (snapshot.empty) { leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No players.</td></tr>'; return; }
                leaderboardBody.innerHTML = ''; let rank = 1;
                snapshot.forEach(doc => {
                    const user = doc.data(); const isCurrentUser = currentUser && currentUser.uid === doc.id;
                    leaderboardBody.innerHTML += `<tr style="${isCurrentUser ? 'background-color: var(--accent-color); color: white;' : ''}"><td>#${rank++}</td><td>${user.username}</td><td>${formatGlorpies(user.glorpies)}</td></tr>`;
                });
            } catch (error) { console.error("Error loading leaderboard:", error); }
        }

        function updateUI() {
            balanceDisplay.textContent = formatGlorpies(playerData.glorpies);
            const inventoryKeys = Object.keys(playerData.inventory || {});
            if (inventoryKeys.length === 0) {
                inventoryGrid.innerHTML = '<p style="color:#888; text-align:center; grid-column: 1 / -1;">Your inventory is empty.</p>';
                return;
            }
            inventoryGrid.innerHTML = inventoryKeys.map(filename => {
                const itemData = playerData.inventory[filename]; const details = caseItems.find(ci => ci.filename === filename); if (!details) return '';
                const probText = details.probability < 0.001 ? '<0.001%' : details.probability.toFixed(2) + '%';
                return `<div class="inventory-item ${getRarityClass(details.probability)} ${itemData.locked ? 'locked' : ''}"><div class="item-count">x${itemData.count}</div><img src="${FOLDER_PATH + details.filename}" alt="${details.name}"><p class="item-name">${details.name}</p><p class="item-chance">Drop: ${probText}</p><p class="item-value">${formatGlorpies(details.value)}</p><div class="item-actions"><button class="action-btn sell-btn" data-filename="${filename}" ${itemData.locked ? 'disabled' : ''}>Sell</button><button class="action-btn lock-btn ${itemData.locked ? 'locked' : ''}" data-filename="${filename}">${itemData.locked ? 'Unlock' : 'Lock'}</button></div></div>`;
            }).join('');
        }

        inventoryGrid.addEventListener('click', e => {
            const filename = e.target.dataset.filename; if (!filename) return;
            const item = playerData.inventory[filename]; if (!item) return;

            if (e.target.classList.contains('sell-btn')) {
                if (item.locked) return;
                let amountToSell = prompt(`How many "${parseName(filename)}" do you want to sell? (You have ${item.count})`, item.count);
                amountToSell = parseInt(amountToSell, 10);
                if (isNaN(amountToSell) || amountToSell <= 0) return;
                if (amountToSell > item.count) { alert("You don't have that many items to sell."); return; }
                playerData.glorpies += parseValue(filename) * amountToSell;
                item.count -= amountToSell;
                if (item.count <= 0) { delete playerData.inventory[filename]; }
            } else if (e.target.classList.contains('lock-btn')) {
                item.locked = !item.locked;
            }
            savePlayerData(); updateUI();
        });

        sellAllBtn.addEventListener('click', () => {
            let totalValue = 0, itemsSoldCount = 0; const itemsToSell = [];
            for (const filename in playerData.inventory) {
                const item = playerData.inventory[filename];
                if (!item.locked) { totalValue += parseValue(filename) * item.count; itemsSoldCount += item.count; itemsToSell.push(filename); }
            }
            if (itemsSoldCount === 0) return alert("No unlocked items to sell.");
            if (confirm(`Sell ${itemsSoldCount} item(s) for ${formatGlorpies(totalValue)}?`)) {
                playerData.glorpies += totalValue;
                itemsToSell.forEach(filename => delete playerData.inventory[filename]);
                savePlayerData(); updateUI();
            }
        });
    });
    </script>
</body>
</html>
