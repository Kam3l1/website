<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Stats - Kam3l</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #121212;
            font-family: Arial, sans-serif;
            color: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .back-btn {
            color: white;
            font-size: 24px;
            text-decoration: none;
            transition: color 0.3s;
        }

        .back-btn:hover {
            color: #00ff77;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00ff77, #ff00e6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            flex-grow: 1;
        }

        .spreadsheet-container {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 0 20px rgba(0, 255, 119, 0.1);
            overflow: hidden;
            border: 2px solid #333;
        }

        .spreadsheet {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #2a2a2a;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
        }

        .row-header {
            background: #3a3a3a;
            border: 1px solid #555;
            text-align: center;
            font-weight: bold;
            width: 40px;
            min-width: 40px;
            padding: 4px;
            color: #ccc;
            user-select: none;
        }

        .col-header {
            background: #3a3a3a;
            border: 1px solid #555;
            text-align: center;
            font-weight: bold;
            padding: 4px 8px;
            color: #ccc;
            user-select: none;
            min-width: 80px;
        }

        .cell {
            border: 1px solid #555;
            padding: 4px 8px;
            background: #2a2a2a;
            color: white;
            min-width: 80px;
            height: 20px;
            position: relative;
            cursor: cell;
        }

        .cell:hover {
            background: #3a3a3a;
        }

        .cell.selected {
            background: #4285f4 !important;
            border: 2px solid #66a3ff !important;
            color: white !important;
        }

        .cell.editing {
            padding: 0;
        }

        .cell.merged {
            background: #3a4a3a !important;
            border: 2px solid #00ff77 !important;
        }

        .cell.hidden {
            display: none;
        }

        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            padding: 4px 8px;
            font-family: inherit;
            font-size: inherit;
            background: #2a2a2a;
            color: white;
            outline: none;
            box-sizing: border-box;
        }

        .admin-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #333;
            border: 1px solid #555;
            color: #888;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.3;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .admin-btn:hover {
            opacity: 0.8;
        }

        .admin-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 20px;
            z-index: 1001;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            min-width: 400px;
        }

        .admin-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .password-input {
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            margin-right: 10px;
            width: 200px;
        }

        .github-token-input {
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            width: 100%;
            margin: 10px 0;
        }

        .confirm-btn {
            background: linear-gradient(45deg, #00ff77, #ff00e6);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .close-btn {
            background: #ff4757;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
            margin-left: 10px;
        }

        .toolbar {
            display: none;
            background: #3a3a3a;
            padding: 8px;
            border-bottom: 1px solid #555;
            gap: 10px;
            flex-wrap: wrap;
        }

        .toolbar.visible {
            display: flex;
        }

        .tool-btn {
            background: #2a2a2a;
            border: 1px solid #555;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }

        .tool-btn:hover {
            background: #4a4a4a;
        }

        .tool-btn.active {
            background: #4285f4;
            color: white;
        }

        .tool-btn.merge {
            background: #00ff77;
            color: #000;
        }

        .tool-btn.unmerge {
            background: #ff4757;
            color: white;
        }

        .color-picker {
            width: 30px;
            height: 25px;
            border: 1px solid #ccc;
            cursor: pointer;
            border-radius: 3px;
        }

        .font-size-input {
            width: 50px;
            background: #2a2a2a;
            border: 1px solid #555;
            color: white;
            padding: 4px;
            border-radius: 3px;
            text-align: center;
        }

        .range-selector {
            position: absolute;
            border: 2px dashed #4285f4;
            background: rgba(66, 133, 244, 0.1);
            pointer-events: none;
            display: none;
        }

        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #ccc;
            z-index: 1000;
        }

        .status.success {
            background: #00ff77;
            color: #000;
        }

        .status.error {
            background: #ff4757;
            color: white;
        }

        .github-config {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .config-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .config-label {
            color: #ccc;
            font-size: 12px;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .spreadsheet {
                font-size: 10px;
            }
            
            .cell, .col-header {
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-overlay" id="adminOverlay"></div>
    
    <div class="admin-panel" id="adminPanel">
        <button class="close-btn" onclick="closeAdminPanel()">√ó</button>
        <h3 style="color: white; margin-top: 0;">Tryb Administratora</h3>
        <div>
            <input type="password" class="password-input" id="passwordInput" placeholder="Wpisz has≈Ço...">
            <button class="confirm-btn" onclick="checkPassword()">Potwierd≈∫</button>
        </div>
        
        <div class="github-config" id="githubConfig" style="display: none;">
            <h4 style="color: white; margin: 0 0 10px 0;">Konfiguracja GitHub</h4>
            <div class="config-row">
                <label class="config-label">GitHub Personal Access Token:</label>
                <input type="password" class="github-token-input" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
            </div>
            <div class="config-row">
                <label class="config-label">Nazwa u≈ºytkownika GitHub:</label>
                <input type="text" class="github-token-input" id="githubUsername" placeholder="username">
            </div>
            <div class="config-row">
                <label class="config-label">Nazwa repozytorium:</label>
                <input type="text" class="github-token-input" id="githubRepo" placeholder="repository-name">
            </div>
            <button class="confirm-btn" onclick="saveGithubConfig()" style="width: 100%; margin-top: 10px;">Zapisz konfiguracjƒô</button>
        </div>
    </div>

    <div class="header">
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="title">
            <i class="fas fa-crosshairs"></i> Austin Major 2025 Pickems
        </h1>
        <div></div>
    </div>

    <div class="spreadsheet-container">
        <div class="toolbar" id="toolbar">
            <button class="tool-btn" onclick="formatBold()"><b>B</b></button>
            <button class="tool-btn" onclick="formatItalic()"><i>I</i></button>
            <button class="tool-btn" onclick="formatUnderline()"><u>U</u></button>
            <span style="margin: 0 10px; color: #666;">|</span>
            <button class="tool-btn" onclick="alignLeft()">‚¨ÖÔ∏è</button>
            <button class="tool-btn" onclick="alignCenter()">‚ÜîÔ∏è</button>
            <button class="tool-btn" onclick="alignRight()">‚û°Ô∏è</button>
            <span style="margin: 0 10px; color: #666;">|</span>
            <input type="number" class="font-size-input" id="fontSizeInput" value="11" min="8" max="24" title="Rozmiar czcionki">
            <button class="tool-btn" onclick="changeFontSize()">A</button>
            <span style="margin: 0 10px; color: #666;">|</span>
            <input type="color" class="color-picker" id="bgColorPicker" value="#2a2a2a" onchange="changeBgColor()" title="Kolor t≈Ça kafelka">
            <input type="color" class="color-picker" id="textColorPicker" value="#ffffff" onchange="changeTextColor()" title="Kolor tekstu">
            <span style="margin: 0 10px; color: #666;">|</span>
            <button class="tool-btn merge" onclick="mergeCells()">üîó Po≈ÇƒÖcz</button>
            <button class="tool-btn unmerge" onclick="unmergeCells()">üîì Roz≈ÇƒÖcz</button>
            <span style="margin: 0 10px; color: #666;">|</span>
            <button class="tool-btn" onclick="addRow()">+ Wiersz</button>
            <button class="tool-btn" onclick="addColumn()">+ Kolumna</button>
            <button class="tool-btn" onclick="deleteRow()">- Wiersz</button>
            <button class="tool-btn" onclick="deleteColumn()">- Kolumna</button>
            <span style="margin: 0 10px; color: #666;">|</span>
            <button class="tool-btn" onclick="saveToGithub()">üíæ Zapisz na GitHub</button>
        </div>
        
        <table class="spreadsheet" id="spreadsheet">
            <thead>
                <tr>
                    <th class="row-header"></th>
                    <th class="col-header">A</th>
                    <th class="col-header">B</th>
                    <th class="col-header">C</th>
                    <th class="col-header">D</th>
                    <th class="col-header">E</th>
                    <th class="col-header">F</th>
                    <th class="col-header">G</th>
                    <th class="col-header">H</th>
                </tr>
            </thead>
            <tbody id="spreadsheetBody">
            </tbody>
        </table>
        
        <div class="range-selector" id="rangeSelector"></div>
    </div>

    <button class="admin-btn" onclick="showAdminPanel()">‚öô</button>
    <div class="status" id="status">Gotowy</div>

    <script>
        let isAdminMode = false;
        let selectedCell = null;
        let selectedCells = [];
        let isSelecting = false;
        let startCell = null;
        let mergedCells = new Map();
        let githubConfig = {
            token: '',
            username: '',
            repo: ''
        };
        
        const ADMIN_PASSWORD_HASH = "ce303098f3cd33f4489a00276812742e876087a8525fafaaa4a2e386ddc7dcf5";
        
        function showStatus(message, type = 'normal') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status';
            if (type === 'success') status.classList.add('success');
            if (type === 'error') status.classList.add('error');
            
            setTimeout(() => {
                status.textContent = 'Gotowy';
                status.className = 'status';
            }, 3000);
        }
        
        function initSpreadsheet() {
            const tbody = document.getElementById('spreadsheetBody');
            
            const sampleData = [
                ['Streamers', '3:0', '3:2', '3:2', '0:3', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['test', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
            ];
            
            for (let i = 0; i < 20; i++) {
                const row = document.createElement('tr');
                
                const rowHeader = document.createElement('td');
                rowHeader.className = 'row-header';
                rowHeader.textContent = i + 1;
                row.appendChild(rowHeader);
                
                for (let j = 0; j < 8; j++) {
                    const cell = document.createElement('td');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    if (i < sampleData.length && j < sampleData[i].length) {
                        cell.textContent = sampleData[i][j];
                    }
                    
                    cell.addEventListener('click', selectCell);
                    cell.addEventListener('dblclick', editCell);
                    cell.addEventListener('mousedown', startSelection);
                    cell.addEventListener('mouseover', continueSelection);
                    
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
            }
        }
        
        function showAdminPanel() {
            document.getElementById('adminOverlay').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'block';
        }
        
        function closeAdminPanel() {
            document.getElementById('adminOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            document.getElementById('githubConfig').style.display = 'none';
        }
        
        async function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            if (hashHex === ADMIN_PASSWORD_HASH) {
                isAdminMode = true;
                document.getElementById('toolbar').classList.add('visible');
                document.getElementById('githubConfig').style.display = 'block';
                loadGithubConfig();
                showStatus('Tryb administratora aktywowany!', 'success');
            } else {
                showStatus('Nieprawid≈Çowe has≈Ço!', 'error');
            }
        }
        
        function loadGithubConfig() {
            const stored = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (stored.token) {
                document.getElementById('githubToken').value = stored.token;
                document.getElementById('githubUsername').value = stored.username || '';
                document.getElementById('githubRepo').value = stored.repo || '';
                githubConfig = stored;
            }
        }
        
        function saveGithubConfig() {
            githubConfig = {
                token: document.getElementById('githubToken').value,
                username: document.getElementById('githubUsername').value,
                repo: document.getElementById('githubRepo').value
            };
            
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            showStatus('Konfiguracja GitHub zapisana!', 'success');
            closeAdminPanel();
        }
        
        async function loadFromGithub() {
            if (!githubConfig.token || !githubConfig.username || !githubConfig.repo) {
                return;
            }
            
            try {
                showStatus('≈Åadowanie danych z GitHub...');
                
                const response = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/spreadsheet-data.json`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const fileData = await response.json();
                    const content = JSON.parse(atob(fileData.content));
                    
                    const rows = document.querySelectorAll('#spreadsheetBody tr');
                    
                    if (content.cells) {
                        content.cells.forEach((rowData, rowIndex) => {
                            if (rows[rowIndex]) {
                                const cells = rows[rowIndex].querySelectorAll('.cell');
                                rowData.forEach((cellData, colIndex) => {
                                    if (cells[colIndex]) {
                                        cells[colIndex].textContent = cellData.text || '';
                                        if (cellData.style) {
                                            Object.assign(cells[colIndex].style, cellData.style);
                                        }
                                        
                                        if (cellData.merged) {
                                            cells[colIndex].classList.add('merged');
                                            if (cellData.colspan) {
                                                cells[colIndex].setAttribute('colspan', cellData.colspan);
                                            }
                                            if (cellData.rowspan) {
                                                cells[colIndex].setAttribute('rowspan', cellData.rowspan);
                                            }
                                        }
                                        if (cellData.hidden) {
                                            cells[colIndex].classList.add('hidden');
                                        }
                                    }
                                });
                            }
                        });
                    }
                    
                    if (content.mergedCells) {
                        mergedCells = new Map(content.mergedCells);
                    }
                    
                    showStatus('Dane za≈Çadowane z GitHub!', 'success');
                } else if (response.status === 404) {
                    showStatus('Brak zapisanych danych na GitHub');
                } else {
                    throw new Error(`GitHub API Error: ${response.status}`);
                }
            } catch (error) {
                console.error('B≈ÇƒÖd podczas ≈Çadowania z GitHub:', error);
                showStatus('B≈ÇƒÖd podczas ≈Çadowania z GitHub', 'error');
            }
        }
        
        async function saveToGithub() {
            if (!isAdminMode) return;
            
            if (!githubConfig.token || !githubConfig.username || !githubConfig.repo) {
                showStatus('Skonfiguruj GitHub w panelu administratora!', 'error');
                return;
            }
            
            try {
                showStatus('Zapisywanie na GitHub...');
                
                const data = [];
                const rows = document.querySelectorAll('#spreadsheetBody tr');
                
                rows.forEach(row => {
                    const rowData = [];
                    const cells = row.querySelectorAll('.cell');
                    cells.forEach(cell => {
                        rowData.push({
                            text: cell.textContent,
                            style: {
                                backgroundColor: cell.style.backgroundColor,
                                color: cell.style.color,
                                fontWeight: cell.style.fontWeight,
                                fontStyle: cell.style.fontStyle,
                                textDecoration: cell.style.textDecoration,
                                fontSize: cell.style.fontSize,
                                textAlign: cell.style.textAlign
                            },
                            merged: cell.classList.contains('merged'),
                            hidden: cell.classList.contains('hidden'),
                            colspan: cell.getAttribute('colspan'),
                            rowspan: cell.getAttribute('rowspan')
                        });
                    });
                    data.push(rowData);
                });
                
                const saveData = {
                    cells: data,
                    mergedCells: Array.from(mergedCells.entries()),
                    lastUpdate: new Date().toISOString()
                };
                
                // Sprawd≈∫ czy plik ju≈º istnieje
                let sha = null;
                try {
                    const existingFile = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/spreadsheet-data.json`, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (existingFile.ok) {
                        const fileData = await existingFile.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // Plik nie istnieje, to OK
                }
                
                // Zapisz plik
                const content = btoa(JSON.stringify(saveData, null, 2));
                const payload = {
                    message: `Update spreadsheet data - ${new Date().toLocaleString()}`,
                    content: content,
                    ...(sha && { sha })
                };
                
                const response = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/spreadsheet-data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    showStatus('Zapisano na GitHub!', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API Error: ${response.status} - ${errorData.message}`);
                }
                
            } catch (error) {
                console.error('B≈ÇƒÖd podczas zapisywania na GitHub:', error);
                showStatus('B≈ÇƒÖd podczas zapisywania na GitHub', 'error');
            }
        }
        
        function selectCell(e) {
            if (selectedCell) {
                selectedCell.classList.remove('selected');
            }
            selectedCell = e.target;
            selectedCell.classList.add('selected');
            
            selectedCells.forEach(cell => cell.classList.remove('selected'));
            selectedCells = [selectedCell];
        }
        
        function editCell(e) {
            if (!isAdminMode) return;
            
            const cell = e.target;
            const currentText = cell.textContent;
            
            cell.classList.add('editing');
            cell.innerHTML = `<input type="text" class="cell-input" value="${currentText}">`;
            
            const input = cell.querySelector('.cell-input');
            input.focus();
            input.select();
            
            input.addEventListener('blur', () => finishEdit(cell, input));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    finishEdit(cell, input);
                } else if (e.key === 'Escape') {
                    cell.textContent = currentText;
                    cell.classList.remove('editing');
                }
            });
        }
        
        function finishEdit(cell, input) {
            cell.textContent = input.value;
            cell.classList.remove('editing');
        }
        
        function startSelection(e) {
            if (!isAdminMode) return;
            isSelecting = true;
            startCell = e.target;
        }
        
        function continueSelection(e) {
            if (!isSelecting || !isAdminMode) return;
            
            const endCell = e.target;
            const startRow = parseInt(startCell.dataset.row);
            const startCol = parseInt(startCell.dataset.col);
            const endRow = parseInt(endCell.dataset.row);
            const endCol = parseInt(endCell.dataset.col);
            
            selectedCells.forEach(cell => cell.classList.remove('selected'));
            selectedCells = [];
            
            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);
            
            for (let r = minRow; r <= maxRow; r++) {
                for (let c = minCol; c <= maxCol; c++) {
                    const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                    if (cell && !cell.classList.contains('hidden')) {
                        cell.classList.add('selected');
                        selectedCells.push(cell);
                    }
                }
            }
        }
        
        document.addEventListener('mouseup', () => {
            isSelecting = false;
        });
        
        function formatBold() {
            if (!isAdminMode || selectedCells.length === 0) return;
            selectedCells.forEach(cell => {
                cell.style.fontWeight = cell.style.fontWeight === 'bold' ? 'normal' : 'bold';
            });
        }
        
        function formatItalic() {
            if (!isAdminMode || selectedCells.length === 0) return;
            selectedCells.forEach(cell => {
                cell.style.fontStyle = cell.style.fontStyle === 'italic' ? 'normal' : 'italic';
            });
        }
        
        function formatUnderline() {
            if (!isAdminMode || selectedCells.length === 0) return;
            selectedCells.forEach(cell => {
                cell.style.textDecoration = cell.style.textDecoration === 'underline' ? 'none' : 'underline';
            });
        }

        function alignLeft() {
            if (!isAdminMode || selectedCells.length === 0) return;
            selectedCells.forEach(cell => {
                cell.style.textAlign = 'left';
            });
        }

        function alignCenter() {
            if (!isAdminMode || selectedCells.length === 0) return;
            selectedCells.forEach(cell => {
                cell.style.textAlign = 'center';
            });
        }

        function alignRight() {
            if (!isAdminMode || selectedCells.length === 0) return;
            selectedCells.forEach(cell => {
                cell.style.textAlign = 'right';
            });
        }
        
        function changeFontSize() {
            if (!isAdminMode || selectedCells.length === 0) return;
            const fontSize = document.getElementById('fontSizeInput').value;
            selectedCells.forEach(cell => {
                cell.style.fontSize = fontSize + 'px';
            });
        }
        
        function changeBgColor() {
            if (!isAdminMode || selectedCells.length === 0) return;
            const color = document.getElementById('bgColorPicker').value;
            selectedCells.forEach(cell => {
                cell.style.backgroundColor = color;
            });
        }
        
        function changeTextColor() {
            if (!isAdminMode || selectedCells.length === 0) return;
            const color = document.getElementById('textColorPicker').value;
            selectedCells.forEach(cell => {
                cell.style.color = color;
            });
        }
        
        function mergeCells() {
            if (!isAdminMode || selectedCells.length < 2) {
                alert('Zaznacz co najmniej 2 kom√≥rki do po≈ÇƒÖczenia!');
                return;
            }
            
            // Znajd≈∫ kom√≥rkƒô g≈Ç√≥wnƒÖ (g√≥rna lewa)
            const rows = selectedCells.map(cell => parseInt(cell.dataset.row));
            const cols = selectedCells.map(cell => parseInt(cell.dataset.col));
            const minRow = Math.min(...rows);
            const minCol = Math.min(...cols);
            const maxRow = Math.max(...rows);
            const maxCol = Math.max(...cols);
            
            const mainCell = selectedCells.find(cell => 
                parseInt(cell.dataset.row) === minRow && 
                parseInt(cell.dataset.col) === minCol
            );
            
            if (!mainCell) return;
            
            // Oblicz wymiary po≈ÇƒÖczonej kom√≥rki
            const rowSpan = maxRow - minRow + 1;
            const colSpan = maxCol - minCol + 1;
            
            // Ustaw colspan i rowspan
            mainCell.setAttribute('colspan', colSpan);
            mainCell.setAttribute('rowspan', rowSpan);
            mainCell.classList.add('merged');
            
            // Zbierz tekst ze wszystkich kom√≥rek
            const allText = selectedCells.map(cell => cell.textContent).filter(text => text.trim()).join(' ');
            mainCell.textContent = allText;
            
            // Ukryj pozosta≈Çe kom√≥rki
            selectedCells.forEach(cell => {
                if (cell !== mainCell) {
                    cell.classList.add('hidden');
                }
            });
            
            // Zapisz informacje o po≈ÇƒÖczeniu
            const mergeKey = `${minRow}-${minCol}`;
            mergedCells.set(mergeKey, {
                rowSpan: rowSpan,
                colSpan: colSpan,
                hiddenCells: selectedCells.filter(cell => cell !== mainCell).map(cell => ({
                    row: parseInt(cell.dataset.row),
                    col: parseInt(cell.dataset.col)
                }))
            });
            
            console.log('Kom√≥rki po≈ÇƒÖczone:', mergeKey, mergedCells.get(mergeKey));
        }
        
        function unmergeCells() {
            if (!isAdminMode || selectedCells.length === 0) return;
            
            selectedCells.forEach(cell => {
                if (cell.classList.contains('merged')) {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    const mergeKey = `${row}-${col}`;
                    
                    if (mergedCells.has(mergeKey)) {
                        const mergeInfo = mergedCells.get(mergeKey);
                        
                        // Usu≈Ñ colspan i rowspan
                        cell.removeAttribute('colspan');
                        cell.removeAttribute('rowspan');
                        cell.classList.remove('merged');
                        
                        // Poka≈º ukryte kom√≥rki
                        mergeInfo.hiddenCells.forEach(hiddenCell => {
                            const hiddenElement = document.querySelector(`[data-row="${hiddenCell.row}"][data-col="${hiddenCell.col}"]`);
                            if (hiddenElement) {
                                hiddenElement.classList.remove('hidden');
                            }
                        });
                        
                        // Usu≈Ñ informacje o po≈ÇƒÖczeniu
                        mergedCells.delete(mergeKey);
                        
                        console.log('Kom√≥rki roz≈ÇƒÖczone:', mergeKey);
                    }
                }
            });
        }
        
        function addRow() {
            if (!isAdminMode) return;
            const tbody = document.getElementById('spreadsheetBody');
            const rowCount = tbody.children.length;
            const row = document.createElement('tr');
            
            // Nag≈Ç√≥wek wiersza
            const rowHeader = document.createElement('td');
            rowHeader.className = 'row-header';
            rowHeader.textContent = rowCount + 1;
            row.appendChild(rowHeader);
            
            // Kom√≥rki
            for (let j = 0; j < 8; j++) {
                const cell = document.createElement('td');
                cell.className = 'cell';
                cell.dataset.row = rowCount;
                cell.dataset.col = j;
                
                cell.addEventListener('click', selectCell);
                cell.addEventListener('dblclick', editCell);
                cell.addEventListener('mousedown', startSelection);
                cell.addEventListener('mouseover', continueSelection);
                
                row.appendChild(cell);
            }
            
            tbody.appendChild(row);
        }
        
        function addColumn() {
            if (!isAdminMode) return;
            // Dodaj nag≈Ç√≥wek kolumny
            const headerRow = document.querySelector('thead tr');
            const colCount = headerRow.children.length - 1;
            const colLetter = String.fromCharCode(65 + colCount);
            
            const newHeader = document.createElement('th');
            newHeader.className = 'col-header';
            newHeader.textContent = colLetter;
            headerRow.appendChild(newHeader);
            
            // Dodaj kom√≥rki do wszystkich wierszy
            const rows = document.querySelectorAll('#spreadsheetBody tr');
            rows.forEach((row, rowIndex) => {
                const cell = document.createElement('td');
                cell.className = 'cell';
                cell.dataset.row = rowIndex;
                cell.dataset.col = colCount;
                
                cell.addEventListener('click', selectCell);
                cell.addEventListener('dblclick', editCell);
                cell.addEventListener('mousedown', startSelection);
                cell.addEventListener('mouseover', continueSelection);
                
                row.appendChild(cell);
            });
        }
        
        function deleteRow() {
            if (!isAdminMode || !selectedCell) return;
            const rowIndex = parseInt(selectedCell.dataset.row);
            const rows = document.querySelectorAll('#spreadsheetBody tr');
            if (rows[rowIndex]) {
                rows[rowIndex].remove();
                // Przenumeruj wiersze
                document.querySelectorAll('#spreadsheetBody tr').forEach((row, index) => {
                    row.querySelector('.row-header').textContent = index + 1;
                    row.querySelectorAll('.cell').forEach(cell => {
                        cell.dataset.row = index;
                    });
                });
            }
        }
        
        function deleteColumn() {
            if (!isAdminMode || !selectedCell) return;
            const colIndex = parseInt(selectedCell.dataset.col);
            
            // Usu≈Ñ nag≈Ç√≥wek kolumny
            const headers = document.querySelectorAll('.col-header');
            if (headers[colIndex + 1]) {
                headers[colIndex + 1].remove();
            }
            
            // Usu≈Ñ kom√≥rki z wszystkich wierszy
            const rows = document.querySelectorAll('#spreadsheetBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('.cell');
                if (cells[colIndex]) {
                    cells[colIndex].remove();
                }
            });
        }
        
        function saveSpreadsheet() {
            if (!isAdminMode) return;
            
            const data = [];
            const rows = document.querySelectorAll('#spreadsheetBody tr');
            
            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('.cell');
                cells.forEach(cell => {
                    rowData.push({
                        text: cell.textContent,
                        style: {
                            backgroundColor: cell.style.backgroundColor,
                            color: cell.style.color,
                            fontWeight: cell.style.fontWeight,
                            fontStyle: cell.style.fontStyle,
                            textDecoration: cell.style.textDecoration,
                            fontSize: cell.style.fontSize,
                            textAlign: cell.style.textAlign
                        },
                        merged: cell.classList.contains('merged'),
                        hidden: cell.classList.contains('hidden'),
                        colspan: cell.getAttribute('colspan'),
                        rowspan: cell.getAttribute('rowspan')
                    });
                });
                data.push(rowData);
            });
            
            // Zapisz do localStorage jako backup (bez powiadomienia)
            const saveData = {
                cells: data,
                mergedCells: Array.from(mergedCells.entries())
            };
            const dataStorage = {};
            dataStorage['csStatsSpreadsheet'] = JSON.stringify(saveData);
            
            console.log('Dane zapisane automatycznie');
        }
        
        // Za≈Çaduj dane przy starcie
        function loadSpreadsheet() {
            const dataStorage = {};
            const savedData = dataStorage['csStatsSpreadsheet'];
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    const rows = document.querySelectorAll('#spreadsheetBody tr');
                    
                    // Przywr√≥ƒá kom√≥rki
                    if (data.cells) {
                        data.cells.forEach((rowData, rowIndex) => {
                            if (rows[rowIndex]) {
                                const cells = rows[rowIndex].querySelectorAll('.cell');
                                rowData.forEach((cellData, colIndex) => {
                                    if (cells[colIndex]) {
                                        cells[colIndex].textContent = cellData.text;
                                        Object.assign(cells[colIndex].style, cellData.style);
                                        
                                        if (cellData.merged) {
                                            cells[colIndex].classList.add('merged');
                                            if (cellData.colspan) {
                                                cells[colIndex].setAttribute('colspan', cellData.colspan);
                                            }
                                            if (cellData.rowspan) {
                                                cells[colIndex].setAttribute('rowspan', cellData.rowspan);
                                            }
                                        }
                                        if (cellData.hidden) {
                                            cells[colIndex].classList.add('hidden');
                                        }
                                    }
                                });
                            }
                        });
                    }
                    
                    // Przywr√≥ƒá informacje o po≈ÇƒÖczonych kom√≥rkach
                    if (data.mergedCells) {
                        mergedCells = new Map(data.mergedCells);
                    }
                } catch (e) {
                    console.error('B≈ÇƒÖd podczas ≈Çadowania danych:', e);
                }
            }
        }
        
        // Inicjalizuj po za≈Çadowaniu strony
        document.addEventListener('DOMContentLoaded', () => {
            initSpreadsheet();
            loadSpreadsheet();
        });
        
        // Autosave co 10 sekund w trybie admin (bez powiadomie≈Ñ)
        setInterval(() => {
            if (isAdminMode) {
                const data = [];
                const rows = document.querySelectorAll('#spreadsheetBody tr');
                
                rows.forEach(row => {
                    const rowData = [];
                    const cells = row.querySelectorAll('.cell');
                    cells.forEach(cell => {
                        rowData.push({
                            text: cell.textContent,
                            style: {
                                backgroundColor: cell.style.backgroundColor,
                                color: cell.style.color,
                                fontWeight: cell.style.fontWeight,
                                fontStyle: cell.style.fontStyle,
                                textDecoration: cell.style.textDecoration,
                                fontSize: cell.style.fontSize
                            },
                            merged: cell.classList.contains('merged'),
                            hidden: cell.classList.contains('hidden'),
                            colspan: cell.getAttribute('colspan'),
                            rowspan: cell.getAttribute('rowspan')
                        });
                    });
                    data.push(rowData);
                });
                
                const saveData = {
                    cells: data,
                    mergedCells: Array.from(mergedCells.entries())
                };
                const dataStorage = {};
                dataStorage['csStatsSpreadsheet'] = JSON.stringify(saveData);
            }
        }, 10000);
    </script>
</body>
</html>
